<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR ë³´ë¬¼ì°¾ê¸°(ìˆ¨ê²¨ì§„ ë™ë¬¼ì„ ì°¾ì•„ë¼!)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            text-align: center;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            touch-action: manipulation;
            user-select: none;
        }
        h1 { font-size: 1.5rem; color: #333; margin-bottom: 20px; }
        
        #instructions {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0 auto 30px;
            max-width: 500px;
            font-size: 1rem;
            line-height: 1.6;
            color: #555;
            text-align: left;
        }

        .action-btn {
            display: block;
            width: 100%;
            margin-top: 15px;
            padding: 15px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #388E3C;
            transition: all 0.1s;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #388E3C; }

        #scan-btn {
            background-color: #2196F3;
            box-shadow: 0 4px 0 #1976D2;
            display: none;
        }
        #scan-btn:active { box-shadow: 0 0 0 #1976D2; }

        #reader-container {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #reader {
            width: 100%;
            max-width: 500px;
        }
        #close-reader-btn {
            margin-top: 20px;
            padding: 10px 30px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
        }

        #game-board {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        .item-slot {
            aspect-ratio: 1 / 1;
            background-color: #fff;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            filter: grayscale(100%) opacity(0.3);
        }
        #chest-slot { font-size: 3.5rem; filter: none; opacity: 1; }
        .item-slot.found {
            filter: grayscale(0%) opacity(1);
            background-color: #e3f2fd;
            border: 2px solid #2196F3;
            animation: bounce 0.6s;
        }
        #chest-slot.open {
            background-color: #fff8e1;
            border: 2px solid #ffc107;
            animation: spin 0.6s;
        }

        #win-message {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            animation: slideUp 0.5s ease-out;
        }
        .password { font-size: 1.5rem; font-weight: bold; color: #1976D2; background: #eee; padding: 5px 15px; border-radius: 8px; }

        #admin-controls { display: none; margin-top: 50px; border-top: 1px solid #ddd; padding-top: 20px; }
        .admin-btn { background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; color: #888; font-size: 0.8rem; }
        body.admin-mode { border: 4px solid #f44336; }
        #reset-all-btn { display: none; background-color: #f44336; color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        body.admin-mode .item-slot.found::after { content: "âŒ"; position: absolute; top: -5px; right: -5px; font-size: 1rem; background: white; border-radius: 50%; border: 1px solid red; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <button id="reset-all-btn" onclick="resetAllData()">âš ï¸ ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸° âš ï¸</button>

    <div id="reader-container">
        <div style="color:white; margin-bottom:10px; font-size:1.2rem;">QR ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”</div>
        <div id="reader"></div>
        <button id="close-reader-btn" onclick="stopScanner()">ë‹«ê¸°</button>
    </div>

    <h1>ğŸ« ìˆ¨ê²¨ì§„ ë™ë¬¼ì„ ì°¾ì•„ë¼!</h1>

    <div id="instructions">
        <strong>[ì°¸ì—¬ ë°©ë²•]</strong><br>
        1. <strong>[â–¶ ê²Œì„ ì‹œì‘]</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
        2. ê³³ê³³ì— ìˆ¨ê²¨ì§„ ë™ë¬¼ QRì„ ì°¾ì•„ë³´ì„¸ìš”.<br>
        3. <strong>[ğŸ“· QR ìŠ¤ìº”í•˜ê¸°]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¹´ë©”ë¼ë¥¼ ì¼œê³  QRì„ í™•ì¸í•˜ì„¸ìš”.<br>
        4. ëª¨ë“  QRì½”ë“œë¥¼ ì°¾ìœ¼ë©´ ë³´ë¬¼ìƒìê°€ ì—´ë¦¬ê³  ìˆ¨ê²¨ì§„ ë¹„ë°€ë²ˆí˜¸ê°€ ë³´ì…ë‹ˆë‹¤.<br>
        5. ìˆ¨ê²¨ì§„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê°€ì§€ê³  ì„ ìƒë‹˜ê»˜ ì˜¤ì„¸ìš”.<br>
        
        <button id="start-btn" class="action-btn" onclick="startGame()">â–¶ ê²Œì„ ì‹œì‘</button>
        <button id="scan-btn" class="action-btn" onclick="startScanner()">ğŸ“· QR ìŠ¤ìº”í•˜ê¸°</button>
    </div>

    <div id="game-board">
        <div class="item-slot" id="cat" onclick="handleItemClick('cat')">ğŸ±</div>
        <div class="item-slot" id="dog" onclick="handleItemClick('dog')">ğŸ¶</div>
        <div class="item-slot" id="rabbit" onclick="handleItemClick('rabbit')">ğŸ°</div>
        
        <div class="item-slot" id="bear" onclick="handleItemClick('bear')">ğŸ»</div>
        <div class="item-slot" id="chest-slot">ğŸ</div>
        <div class="item-slot" id="turtle" onclick="handleItemClick('turtle')">ğŸ¢</div>

        <div class="item-slot" id="fish" onclick="handleItemClick('fish')">ğŸ </div>
        <div class="item-slot" id="bird" onclick="handleItemClick('bird')">ğŸ¦</div>
        <div class="item-slot" id="butterfly" onclick="handleItemClick('butterfly')">ğŸ¦‹</div>
    </div>

    <div id="win-message">
        <h2>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
        <p>ëª¨ë“  ë™ë¬¼ë“¤ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>
        <p>ë³´ë¬¼ìƒìì˜ ë¹„ë°€ë²ˆí˜¸ëŠ”:</p>
        <div class="password">ì€ë°°ìŒ¤ì„ ì¡´ê²½í•˜ë¼!!</div>
        <p>ì„ ìƒë‹˜ê»˜ ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”!</p>
    </div>

    <div id="admin-controls">
        <button class="admin-btn" onclick="toggleAdminMode()">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</button>
    </div>

    <script>
        const MASTER_PASSWORD = "1234"; 
        const items = ['cat', 'dog', 'rabbit', 'bear', 'turtle', 'fish', 'bird', 'butterfly'];
        let isAdminMode = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let html5QrCode;

        document.addEventListener('DOMContentLoaded', () => {
            const isStarted = localStorage.getItem('gameStarted');
            if (isStarted === 'true') {
                showGameScreen();
                checkURLQRCode();
                updateBoard();
            }
            document.body.addEventListener('click', () => {
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }, {once:true});
        });

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playTone('start');
            localStorage.setItem('gameStarted', 'true');
            showGameScreen();
            checkURLQRCode();
            updateBoard();
        }

        function showGameScreen() {
            document.getElementById('game-board').style.display = 'grid';
            document.getElementById('admin-controls').style.display = 'block';
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('scan-btn').style.display = 'block';
        }

        function startScanner() {
            document.getElementById('reader-container').style.display = 'flex';
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("ì¹´ë©”ë¼ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                stopScanner();
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader-container').style.display = 'none';
                    html5QrCode.clear();
                }).catch(err => {
                    document.getElementById('reader-container').style.display = 'none';
                });
            } else {
                document.getElementById('reader-container').style.display = 'none';
            }
        }

        // [ìµœì¢… ìˆ˜ì •] ë””ë²„ê·¸ ì•Œë¦¼ ì œê±° ë° ì•ˆì •ì ì¸ ì¸ì‹ ë¡œì§
        function onScanSuccess(decodedText, decodedResult) {
            let detectedCode = null;
            let cleanText = decodedText.trim();

            for (let item of items) {
                if (cleanText === item) {
                    detectedCode = item;
                    break;
                }
                if (cleanText.includes("code=" + item)) {
                    detectedCode = item;
                    break;
                }
            }

            if (detectedCode) {
                html5QrCode.pause(); 
                processFoundItem(detectedCode);
                setTimeout(() => { stopScanner(); }, 1000);
            } else {
                // ì¸ì‹ì€ í–ˆì§€ë§Œ ìš°ë¦¬ ê²Œì„ QRì´ ì•„ë‹˜ -> ì•„ë¬´ ì¼ë„ í•˜ì§€ ì•ŠìŒ (ê³„ì† ìŠ¤ìº”)
                // ë””ë²„ê¹… ì•Œë¦¼ ì œê±°ë¨
            }
        }

        function checkURLQRCode() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code && items.includes(code)) {
                processFoundItem(code);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function processFoundItem(code) {
            let foundList = JSON.parse(localStorage.getItem('myAnimals')) || [];
            
            if (!foundList.includes(code)) {
                foundList.push(code);
                localStorage.setItem('myAnimals', JSON.stringify(foundList));
                playTone('found');
                alert('ì•¼í˜¸! ' + getEmoji(code) + 'ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!');
            } else {
                alert('ì´ë¯¸ ì°¾ì€ ë™ë¬¼ì…ë‹ˆë‹¤: ' + getEmoji(code));
            }
            updateBoard();
        }

        function updateBoard() {
            const foundList = JSON.parse(localStorage.getItem('myAnimals')) || [];
            items.forEach(id => { document.getElementById(id).classList.remove('found'); });
            foundList.forEach(id => {
                const element = document.getElementById(id);
                if(element) element.classList.add('found');
            });

            if (foundList.length === items.length) {
                const chest = document.getElementById('chest-slot');
                if (!chest.classList.contains('open')) {
                    setTimeout(() => { playTone('win'); }, 500);
                }
                chest.innerHTML = 'ğŸ’';
                chest.classList.add('open');
                document.getElementById('win-message').style.display = 'block';
                document.getElementById('scan-btn').style.display = 'none';
            } else {
                const chest = document.getElementById('chest-slot');
                chest.innerHTML = 'ğŸ';
                chest.classList.remove('open');
                document.getElementById('win-message').style.display = 'none';
            }
        }

        function playTone(type) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'found') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(659.25, audioCtx.currentTime + 0.1); 
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'win') {
                playNote(523.25, 0, 0.2); 
                playNote(659.25, 0.2, 0.4); 
                playNote(783.99, 0.4, 1.0); 
            } else if (type === 'start') {
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            }
        }
        function playNote(freq, startTime, duration) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime + startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + startTime + duration);
            osc.start(audioCtx.currentTime + startTime);
            osc.stop(audioCtx.currentTime + startTime + duration);
        }

        function toggleAdminMode() {
            const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (input === MASTER_PASSWORD) {
                isAdminMode = !isAdminMode;
                if (isAdminMode) {
                    document.body.classList.add('admin-mode');
                    document.getElementById('reset-all-btn').style.display = 'inline-block';
                    alert("ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ ON");
                } else {
                    document.body.classList.remove('admin-mode');
                    document.getElementById('reset-all-btn').style.display = 'none';
                    alert("ê´€ë¦¬ì ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            } else if(input !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }

        function resetAllData() {
            if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ê³  ì²˜ìŒë¶€í„° ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('myAnimals');
                localStorage.removeItem('gameStarted');
                location.reload();
            }
        }

        function handleItemClick(id) {
            if (!isAdminMode) return;
            let foundList = JSON.parse(localStorage.getItem('myAnimals')) || [];
            if (foundList.includes(id)) {
                if (confirm(getEmoji(id) + " íšë“ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    foundList = foundList.filter(item => item !== id);
                    localStorage.setItem('myAnimals', JSON.stringify(foundList));
                    updateBoard();
                }
            }
        }

        function getEmoji(id) {
            const emojiMap = { 'cat': 'ğŸ±', 'dog': 'ğŸ¶', 'rabbit': 'ğŸ°', 'bear': 'ğŸ»', 'turtle': 'ğŸ¢', 'fish': 'ğŸ ', 'bird': 'ğŸ¦', 'butterfly': 'ğŸ¦‹' };
            return emojiMap[id] || 'ë™ë¬¼';
        }
    </script>
</body>
</html>
