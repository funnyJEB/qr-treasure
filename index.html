<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR ë³´ë¬¼ì°¾ê¸° (V7)</title>
    <style>
        body {
            font-family: "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            text-align: center;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            touch-action: manipulation;
            user-select: none;
        }
        h1 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
        }
        
        /* ì„¤ëª… ë°•ìŠ¤ */
        #instructions {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0 auto 30px;
            max-width: 500px;
            font-size: 1rem;
            line-height: 1.6;
            color: #555;
            text-align: left;
        }

        /* ê²Œì„ ì‹œì‘ ë²„íŠ¼ */
        #start-btn {
            display: block;
            width: 100%;
            margin-top: 15px;
            padding: 12px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #388E3C;
            transition: all 0.1s;
        }
        #start-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #388E3C;
        }

        /* ê²Œì„ ë³´ë“œíŒ (ì²˜ìŒì—” ìˆ¨ê¹€) */
        #game-board {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        /* ì•„ì´í…œ ì¹¸ ìŠ¤íƒ€ì¼ */
        .item-slot {
            aspect-ratio: 1 / 1;
            background-color: #fff;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
            filter: grayscale(100%) opacity(0.3);
        }

        #chest-slot {
            font-size: 3.5rem;
            filter: none;
            opacity: 1;
            cursor: default;
        }

        .item-slot.found {
            filter: grayscale(0%) opacity(1);
            background-color: #e3f2fd;
            border: 2px solid #2196F3;
            animation: bounce 0.6s;
        }

        /* ê´€ë¦¬ì ëª¨ë“œ ì‚­ì œ í‘œì‹œ */
        body.admin-mode .item-slot.found::after {
            content: "âŒ";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 1rem;
            background: white;
            border-radius: 50%;
            border: 1px solid red;
        }
        
        #chest-slot.open {
            background-color: #fff8e1;
            border: 2px solid #ffc107;
            animation: spin 0.6s;
        }

        #win-message {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            animation: slideUp 0.5s ease-out;
        }
        .password { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #1976D2; 
            background: #eee; 
            padding: 5px 15px; 
            border-radius: 8px; 
        }

        /* ê´€ë¦¬ì ë²„íŠ¼ ì˜ì—­ */
        #admin-controls {
            display: none;
            margin-top: 50px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .admin-btn {
            background: none;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 5px;
            color: #888;
            font-size: 0.8rem;
            cursor: pointer;
        }
        body.admin-mode { border: 4px solid #f44336; }
        #reset-all-btn {
            display: none;
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <button id="reset-all-btn" onclick="resetAllData()">âš ï¸ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” âš ï¸</button>

    <h1>ğŸ« ìš°ë¦¬ ë°˜ ë™ë¬¼ë†ì¥ ë³´ë¬¼ì°¾ê¸°</h1>

    <div id="instructions">
        <strong>[ì°¸ì—¬ ë°©ë²•]</strong><br>
        1. <strong>[â–¶ ê²Œì„ ì‹œì‘]</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
        2. ê³³ê³³ì— ìˆ¨ê²¨ì§„ <strong>ë™ë¬¼ QR ì½”ë“œ</strong>ë¥¼ ì°¾ì•„ ì¹´ë©”ë¼ë¡œ ë¹„ì¶”ì–´ë³´ì„¸ìš”.<br>
        3. ëª¨ë“  ë™ë¬¼ QRì½”ë“œë¥¼ ì°¾ìœ¼ë©´ ë³´ë¬¼ìƒìê°€ ì—´ë¦½ë‹ˆë‹¤!
        
        <button id="start-btn" onclick="startGame()">â–¶ ê²Œì„ ì‹œì‘ (ì†Œë¦¬ ì¼œê¸°)</button>
    </div>

    <div id="game-board">
        <div class="item-slot" id="cat" onclick="handleItemClick('cat')">ğŸ±</div>
        <div class="item-slot" id="dog" onclick="handleItemClick('dog')">ğŸ¶</div>
        <div class="item-slot" id="rabbit" onclick="handleItemClick('rabbit')">ğŸ°</div>
        
        <div class="item-slot" id="bear" onclick="handleItemClick('bear')">ğŸ»</div>
        <div class="item-slot" id="chest-slot">ğŸ</div>
        <div class="item-slot" id="turtle" onclick="handleItemClick('turtle')">ğŸ¢</div>

        <div class="item-slot" id="fish" onclick="handleItemClick('fish')">ğŸ </div>
        <div class="item-slot" id="bird" onclick="handleItemClick('bird')">ğŸ¦</div>
        <div class="item-slot" id="butterfly" onclick="handleItemClick('butterfly')">ğŸ¦‹</div>
    </div>

    <div id="win-message">
        <h2>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
        <p>ëª¨ë“  ë™ë¬¼ ì¹œêµ¬ë“¤ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>
        <p>ë³´ë¬¼ìƒìì˜ ë¹„ë°€ë²ˆí˜¸ëŠ”:</p>
        <div class="password">7 2 1 9</div>
        <p>ì„ ìƒë‹˜ê»˜ ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”!</p>
    </div>

    <div id="admin-controls">
        <button class="admin-btn" onclick="toggleAdminMode()">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</button>
    </div>

    <script>
        const MASTER_PASSWORD = "1234"; 
        const items = ['cat', 'dog', 'rabbit', 'bear', 'turtle', 'fish', 'bird', 'butterfly'];
        let isAdminMode = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ (ìë™ ì‹œì‘ í™•ì¸)
        document.addEventListener('DOMContentLoaded', () => {
            // "ê²Œì„ ì‹œì‘" ë²„íŠ¼ì„ ì´ë¯¸ ëˆŒë €ëŠ”ì§€ í™•ì¸
            const isStarted = localStorage.getItem('gameStarted');
            
            if (isStarted === 'true') {
                // ì´ë¯¸ ì‹œì‘í–ˆë‹¤ë©´ ë°”ë¡œ í™”ë©´ ë³´ì—¬ì£¼ê¸°
                showGameScreen();
                checkQRCode(); // QR ì½”ë“œ í™•ì¸
                updateBoard(); // ë³´ë“œíŒ ê·¸ë¦¬ê¸°
            } else {
                // ì‹œì‘ ì•ˆ í–ˆìœ¼ë©´ QR í™•ì¸ ì•ˆ í•¨ (ì‹œì‘ ë²„íŠ¼ ëŒ€ê¸°)
            }

            // í„°ì¹˜ ì‹œ ì˜¤ë””ì˜¤ ê¶Œí•œ í™•ë³´ (ëª¨ë°”ì¼ í•„ìˆ˜)
            document.body.addEventListener('click', () => {
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }, {once:true});
        });

        // 2. ê²Œì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­
        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playTone('start');
            
            // "ê²Œì„ ì‹œì‘ë¨" ìƒíƒœ ì €ì¥ [í•µì‹¬ ìˆ˜ì • ì‚¬í•­]
            localStorage.setItem('gameStarted', 'true');

            showGameScreen();
            checkQRCode(); // í˜¹ì‹œ QRë¡œ ë°”ë¡œ ì ‘ì†í•˜ê³  ë²„íŠ¼ ëˆŒë €ì„ ê²½ìš°ë¥¼ ìœ„í•´
            updateBoard();
        }

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
        function showGameScreen() {
            document.getElementById('game-board').style.display = 'grid';
            document.getElementById('admin-controls').style.display = 'block';
            document.getElementById('start-btn').style.display = 'none';
        }

        // QR ì½”ë“œ í™•ì¸
        function checkQRCode() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (code && items.includes(code)) {
                let foundList = JSON.parse(localStorage.getItem('myAnimals')) || [];
                
                if (!foundList.includes(code)) {
                    foundList.push(code);
                    localStorage.setItem('myAnimals', JSON.stringify(foundList));
                    
                    // ì†Œë¦¬ ì¬ìƒ (ìë™ ì‹œì‘ ì‹œ ë¸Œë¼ìš°ì € ì •ì±…ìœ¼ë¡œ ì†Œë¦¬ê°€ ì•ˆ ë‚  ìˆ˜ ìˆìŒ -> í„°ì¹˜ ìœ ë„)
                    setTimeout(() => { playTone('found'); }, 300); 
                    alert('ì•¼í˜¸! ' + getEmoji(code) + 'ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!');
                }
                
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function updateBoard() {
            const foundList = JSON.parse(localStorage.getItem('myAnimals')) || [];
            
            items.forEach(id => { document.getElementById(id).classList.remove('found'); });
            foundList.forEach(id => {
                const element = document.getElementById(id);
                if(element) element.classList.add('found');
            });

            if (foundList.length === items.length) {
                const chest = document.getElementById('chest-slot');
                if (!chest.classList.contains('open')) {
                    setTimeout(() => { playTone('win'); }, 500);
                }
                chest.innerHTML = 'ğŸ’';
                chest.classList.add('open');
                document.getElementById('win-message').style.display = 'block';
            } else {
                const chest = document.getElementById('chest-slot');
                chest.innerHTML = 'ğŸ';
                chest.classList.remove('open');
                document.getElementById('win-message').style.display = 'none';
            }
        }

        function playTone(type) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'found') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(659.25, audioCtx.currentTime + 0.1); 
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'win') {
                playNote(523.25, 0, 0.2); 
                playNote(659.25, 0.2, 0.4); 
                playNote(783.99, 0.4, 1.0); 
            } else if (type === 'start') {
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            }
        }

        function playNote(freq, startTime, duration) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime + startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + startTime + duration);
            osc.start(audioCtx.currentTime + startTime);
            osc.stop(audioCtx.currentTime + startTime + duration);
        }

        // --- ê´€ë¦¬ì ê¸°ëŠ¥ ---
        function toggleAdminMode() {
            const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (input === MASTER_PASSWORD) {
                isAdminMode = !isAdminMode;
                if (isAdminMode) {
                    document.body.classList.add('admin-mode');
                    document.getElementById('reset-all-btn').style.display = 'inline-block';
                    alert("ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ ON");
                } else {
                    document.body.classList.remove('admin-mode');
                    document.getElementById('reset-all-btn').style.display = 'none';
                    alert("ê´€ë¦¬ì ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            } else if(input !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }

        function resetAllData() {
            if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ê³  ì²˜ìŒë¶€í„° ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('myAnimals');
                localStorage.removeItem('gameStarted'); // ì‹œì‘ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œ
                location.reload();
            }
        }

        function handleItemClick(id) {
            if (!isAdminMode) return;
            let foundList = JSON.parse(localStorage.getItem('myAnimals')) || [];
            if (foundList.includes(id)) {
                if (confirm(getEmoji(id) + " íšë“ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    foundList = foundList.filter(item => item !== id);
                    localStorage.setItem('myAnimals', JSON.stringify(foundList));
                    updateBoard();
                }
            }
        }

        function getEmoji(id) {
            const emojiMap = {
                'cat': 'ğŸ±', 'dog': 'ğŸ¶', 'rabbit': 'ğŸ°', 'bear': 'ğŸ»',
                'turtle': 'ğŸ¢', 'fish': 'ğŸ ', 'bird': 'ğŸ¦', 'butterfly': 'ğŸ¦‹'
            };
            return emojiMap[id] || 'ë™ë¬¼';
        }
    </script>
</body>
</html>
